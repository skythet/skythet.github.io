---
title: Bash-ты ойын жазу арқылы үйренеміз. 2048 ойыны
tags: bash, game
category: Linux
image: game2048.png
---

Bash скрипттары Linux жүйесінде көптеген жұмыстарды жеңілдетуі мүмкін. Бірақ bash программалық тіл болмағандықтан (жай командалық қабат) оның көптеген өзіне тән ерекшеліктері бар. Сондықтан, оны қолданудан алдын жақсылап үйренуге тура келеді. <!--more--> habrahabr сайтында bash-ты үйрену үшін өте көптеген ойындар жазылған (<a href="http://habrahabr.ru/post/128549/">Шахмат</a>, <a href="http://habrahabr.ru/post/131921/">Quadronix</a>, <a href="http://habrahabr.ru/post/122029/">Xonix</a>, <a href="http://habrahabr.ru/post/80122/">Теңіз соғысы</a>, <a href="http://habrahabr.ru/post/120198/">Sokoban</a>, керек десеңіз <a href="http://habrahabr.ru/post/130021/">3D шутер</a>). Бірақ, менің байқағаным, ол жазылғандарды оқып шығу бір бөлек, ал өзіңе жазу бір бөлек. Өйткені шын жұмыста керек кезде бәрібір, жаңылысып отырасың. Сондықтан мен де үйрену үшін бір ойын жасауды шештім. Ең бастысы ол жай көшірме немесе аударма емес (қарап қоймау үшін :-)), жаңа ойын болуы керек. Сөйтіп, өзіме жақында пайда болған 2048 ойынын таңдап алдым. Өйткені, логикасы оңай және аз уақыттың ішінде жасауға болады. 

Бұл қалай сонда деп отқандарға кішігірім демонстрация ;).

<iframe width="560" height="315" src="//www.youtube.com/embed/qC7rXHhm1hs" frameborder="0" allowfullscreen></iframe>

Алдымен bash-тың ерекшеліктерін қарастырып кетейік.


# Айнымалылар


Bash-скрипттарында айнымалылар типтері деген түсінік жоқ. Айнымалыларды жариялау және мән беру келесі түрде анықталады:

{% highlight bash %}
user@localhost$ my_var # айнымалыны жариялау
user@localhost$ my_var=5 # айнымалыға мән беру
{% endhighlight %}

теңдік символының екі жағында бос орын қалдыруға болмайды, яғни айнымалыға былай мәр беру "my_var = 5" дұрыс емес. Айнымалыны оқу үшін, оның алдына "$" символы қойылады:

{% highlight bash %}
user@localhost$ echo $my_var # немесе ${my_var}
5
user@localhost$ echo "My variable value $my_var" # екі тырнақшаның ішінде пайдалануға болады
My variable 5
{% endhighlight %}

Айнымалыларды "declare" bash конструкциясы (builtin) арқылы типтеуге болады, бұл жақсы практикалардың бірі болып саналады:

{% highlight bash %}
user@localhost$ declare -r MY_CONST=3 # айнымалыны тек оқуға жариялау
user@localhost$ MY_CONST=4
-bash: MY_CONST: readonly variable
{% endhighlight %}

Осы секілді, бұл конструкцияның келесі кілттері бар:
-i - сандық тип
-a - массив
-l - айнамалы мәні тек іші регистрде болады
-u - айнамалы мәні тек үлкен регистрде болады


# Функциялар


Функция келесі түрде анықталады:

{% highlight bash %}
function my_func() {
    :
}
{% endhighlight %}

Бірақ, аргументтерді жақша ішінде беруге болмайды, аргументтер командаға аргумен берген секілді берілед және функция ішінде $1, $2 ... айнымалыларында қол жетімді болады. Мысалы

{% highlight bash %}
function my_func() {
    echo "$1, $2!"
}

my_func "hello" "world"
{% endhighlight %}

нәтижесінде консолда "Hello, world!" мәтіні шығарылады. Функция ішінде declare-нің толық аналогы local пайдаланылады. Келесі ерекшелік өте маңызды:

{% highlight bash %}
i=3

function f() {
    echo $i
}

function g() {
    local i=5
    f
}

function h() {
    local i=10
    f
}

g
h
{% endhighlight %}

Нәтижесінде консольда 5 және 10 шығарылады.


# Массивтер


{% highlight bash %}
my_arr=( 1 2 3 4 ) # массивті анықтау
${my_arr[0]} # массив элементін оқу
my_arr[2]=10 # массив элементінңің мәнін өзгерту
${#my_arr[*]} # массив элементтерінің саны
{% endhighlight %}

Bash-та екі өлшемді массив жоқ. Бірақ бір өлшемді массивті екі өлшемді ретінде пайдалануға болады. Мысалы:

{% highlight bash %}
my_arr=( 
    1 2 3
    4 5 6
    7 8 9
)

for (( i = 0; i < SIZE; i++ )); do
    for (( j = 0; j < SIZE; j++ )); do
        echo "${my_arr[i * 3 + j]}" # 3 баған саны
    done
done
{% endhighlight %}

Бұл қысқаша шолу болатын, егер қызығушылық болса әр тақырыптың өзі үлкен мақала болады. 2048 ойынының ережесін <a href="http://ru.wikipedia.org/wiki/2048_(%D0%B8%D0%B3%D1%80%D0%B0)">википедиядан</a> алдым. Алдымен ойынға керек функцияларды анықтаймыз. Ойынның циклі келесі қадамдардан тұрады:
1. Пайдаланушы басқан бағытқа қарай плиткаларды ығыстыру
2. Плитка мәні 2048-ге жеткенін тексеру
3. Экранға плиткалардың жаңа мәндерін шығару
4. 1-қадамға қайта оралу

Бұл циклді орындайтын басты функцияны анықтаймыз:

{% highlight bash %}
function main() {
    stty -echo # echo өшіру үшін

    newGame # жаңа ойын бастаймыз

    while [[ true ]]; do
        action # плиткаларды ығыстыру
        if [[ $shifted = "true" ]]; then
            placeRandomTile # егер плиткалар ығысқан болса, кездейсоқ плитка қосу
        fi
        display # экранға шығарамыз

        if isYouWin; then # пайдаланушы жеңген жеңбегендігін тексереміз
            askWantContinue
            display
        fi
    done
}
{% endhighlight %}

Плитка мәндерін tiles массивінде сақтаймыз. newGame функциясы оның мәндерін тазалап отырады:

{% highlight bash %}
function newGame() {
    score=0
    shifted=false
    tiles=(
        0 0 0 0
        0 0 0 0
        0 0 0 0
        0 0 0 0
    )

    placeRandomTile; placeRandomTile; # ойын басында екі кездейсоқ плитка қосылады
    display
}
{% endhighlight %}

"action" функциясы пайдаланушының батырма басуын күтіп, плиткаларды керекті жақтарға ығыстырады:

{% highlight bash %}
function action() {
    shifted=false
    local -l key

    read -n 1 key
    case $key in
        $KEY_UP ) shiftToTop ;;
        $KEY_DOWN ) shiftToBottom ;;
        $KEY_LEFT ) shiftToLeft ;;
        $KEY_RIGHT ) shiftToRight ;;
    esac
}
{% endhighlight %}

shiftToTop, shiftToBottom, shiftToLeft, shiftToRight функциялары, сәйкесінше плиткаларды жоғарыға, төменге, солға, оңға ығыстырады. Ал ең үздік нәтижені файлда сақтаймыз. Ол нәтижені жазатын және оқитын функциялар:

{% highlight bash %}
function writeBestScore() {
    if [[ -w $BEST_SCORE_FILE ]]; then
        if (( score > bestScore )); then
            echo "$score" > $BEST_SCORE_FILE
        fi
    fi
}

function readBestScore() {
    if [[ -r $BEST_SCORE_FILE ]]; then
        bestScore=$(cat $BEST_SCORE_FILE)
    else
        bestScore=0
    fi
}
{% endhighlight %}


# Қорытынды


Жазу барысында өте көп шалындым деуге болады, әдемі debugger болмағандықтан, қателіктер не үшін болып жатқанын түсіну қиын. Әсіресе массивтерде шатысып кетесің, толық соңына дейін жақсылап үйрену үшін тағы бір қиындау ойын жазу керек сияқты. Кодым мықты, таза деп мақтана алмайм, бірақ ойынды жазу кішкентай болсын тәжірибе берді.

Ойынды тағы толықтыруға болады, жасалмаған функционалдар:
1. Ойынның соңғы қалпын файлда сақтау
2. Соңғы жүрісті артқа қайтару
3. Пайдаланушының жеңілгендігін тексеру және оған хабарлау
4. Баған бойынша сандарды түзулеу

1 және 2-ші функционалды файлға жазу арқылы істеуге болады. Бірақ екі күн скриптті қарай беріп жалығып кеттім. Кодты келесі ресурстардан қарауға болады: <a href="http://pastebin.com/TqJuZDWq">pastebin</a> және <a href="https://github.com/egemberdiev/game2048">github</a>. href="https://asciinema.org/a/9614">asciinema.org</a> сайтындағы жазба.

Ойынды қосу үшін, келесі командаларды орындаңыз:

{% highlight bash %}
chmod +x game2048.bash
./game2048.bash
{% endhighlight %}

Ойыннан шығу үшін Ctrl+C батырмасын басыңыз.

**UPDATE**. Ең бастысын ұмытып кетіппін. Ойынның басқарылуы. Ойында плиткаларды ығыстыру үшін "w", "s", "a", "d" батырмаларын пайдаланыңыз. Олар, сәйкесінше "Жоғары", "Төмен", "Солға" және "Оңға" ығыстыру.
